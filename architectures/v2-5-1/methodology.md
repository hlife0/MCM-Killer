# v2.5.1 设计方法论 (Methodology)

> **版本**: v2.5.1
> **日期**: 2026-01-10

---

## 文档关系

| 文档 | 职责 |
|------|------|
| `retrospective.md` | 分析 v2.4.2 和 v2.5.0 的问题和改进 |
| `methodology.md`（本文档） | 定义设计原则和方法论 |
| **`architecture.md`** | 定义具体架构和 Agent 契约 |

阅读顺序：retrospective → methodology → architecture

---

## 一、核心设计原则

### 1.1 质量优先原则 (Quality First)

> **核心理念**：宁可多次返工，不可放过问题。

**具体体现**：
- 每个阶段都有 Validation Gate
- 返工后必须重新验证（v2.4.2）
- 质量门槛原则（v2.4.2）
- 禁止"能跑就行"的标准

### 1.2 完整性原则 (Completeness)

> **核心理念**：必须完整执行所有阶段，禁止简化或跳过。

**具体体现**：
- 完整性强制令（v2.4.1）
- 反偷懒机制（v2.5.0）
- Phase 完整性检查清单
- 自动降级但不跳过

### 1.3 数据一致性原则 (Data Consistency)

> **核心理念**：所有输出数据必须一致，可追溯。

**具体体现**：
- 数据完整性标准（v2.4.1）
- 输出一致性原则（v2.4.2）
- 文件保护机制（v2.4.2）
- 日志-文件一致性验证（v2.4.2）

### 1.4 独立验证原则 (Independent Verification)

> **核心理念**：验证者必须独立判断，不依赖他人汇报。

**具体体现**：
- Advisor 独立验证（v2.4.2）
- 亲自读取文件
- Sanity Check 思维
- 禁止验证时发起 Consultation

---

## 二、架构组织原则

### 2.1 分层架构 (Layered Architecture)

v2.5.1 采用清晰的分层架构：

```
architectures/              # 架构定义（前期协调，设计参考）
└── v2-5-1/
    ├── architecture.md     # 权威架构定义
    ├── methodology.md      # 设计方法论
    ├── retrospective.md    # 回顾和分析
    └── agents/             # Agent 模板

workspace/                  # 实际工作区
└── {year}_problem/
    └── .claude/
        └── agents/         # Agent 工作指南（自包含）
```

**关键原则**：
- `architectures/` = 设计协调文档（开发时参考）
- `workspace/.claude/agents/` = 工作执行指南（运行时使用）
- Agent 文件必须**自包含**，不引用架构
- 工作时 AI 只读取 `agents/*.md`，不访问 `architectures/`

### 2.2 自包含原则 (Self-Contained)

> **核心理念**：每个 Agent 文件必须包含执行任务所需的所有信息。

**具体要求**：
- Agent 文件不引用外部架构文档
- 所有必要信息内嵌在文件中
- 可以独立阅读和使用
- 工作时无需访问架构

---

## 三、质量保证机制

### 3.1 多层验证 (Multi-Layer Validation)

**第一层：自动化预验证**
- Validator Agent 运行脚本检查数据质量
- 检查 CSV 格式、数据类型、完整性

**第二层：Validation Gate**
- 每个 Gate 有多个验证者
- 从不同角度验证（题意、技术、质量、创新）
- 返工后必须重新验证

**第三层：Sanity Check**
- 预测结果合理性检查
- 历史对比、常识判断
- 独立数据验证

### 3.2 返工机制 (Rework Mechanism)

**返工不免验**：
- 返工后必须以同样标准重新验证
- 不因为是返工版本就降低要求
- 不假设问题已修复，重新检查所有项

**返工计数**：
- 每个 Gate 最多返工 3 次
- 超过 3 次：讨论是否回退

**回退机制**：
- 有些问题需要回退到更早阶段
- 回退后从回退点开始，所有后续阶段重新执行

### 3.3 质量门槛 (Quality Gates)

**Modeler 严格标准**：
- CODE Gate 中严格审查代码
- 拒绝"能运行但不符合设计"的代码
- 拒绝简化了核心数学逻辑的实现

**Advisor 独立验证**：
- 以"局外人"视角审查
- 亲自读取预测文件
- 高标准高要求，敢于要求返工

---

## 四、反偷懒机制

### 4.1 防止跳过阶段

**问题表现**：
- Phase 5 完全跳过（0% 完成）
- 理由："context 已使用较大"、"模型训练需要 8-10 小时"
- AI 自主决定跳过，未请求用户干预

**解决方案**：

**完整性强制令**：
1. 禁止跳过（No Skipping）
2. 自动降级（Automatic Degradation）
3. 无需人工干预（No Human Intervention）
4. 检查点机制（Checkpoint）

### 4.2 自动降级策略

当资源不足时，**自动降级**而不是跳过：

| Tier | 数据量 | 迭代数 | 预计时间 | 使用场景 |
|------|--------|--------|----------|----------|
| Tier 1 | 100% | 2000 | 4-6 小时 | 标准情况 |
| Tier 2 | 50% | 1000 | 2-3 小时 | 资源有限 |
| Tier 3 | 20% | 500 | ≤1 小时 | 资源紧急 |
| Tier 4 | 10% | MAP | ≤30 分钟 | 资源极端 |

**关键**：无论哪种 Tier，都必须**产生有效输出**。

### 4.3 Phase 5 两阶段训练

**Phase 5A: 快速验证（MANDATORY）**:
- ✅ 必须执行
- 使用减少样本/迭代
- 确保代码可运行
- 预计时间：≤30 分钟
- 输出：`results_quick_1.csv`

**Phase 5B: 完整训练（OPTIONAL）**:
- ⚠️ 可选执行
- 完整 HMC 采样
- 预计时间：4-6 小时
- 输出：`results_1.csv`

**禁止行为**：
- ❌ 完全跳过 Phase 5
- ❌ 理由"时间不足"就跳过
- ✅ 必须至少完成 Phase 5A

---

## 五、资源管理机制

### 5.1 Token 监控

**监控时机**：
- 每个 Phase 结束时检查 Token 使用

**阈值和行动**：
| Token 使用率 | 行动 |
|-------------|------|
| < 80% | 正常执行，记录到检查点 |
| 80% - 90% | 发出警告，考虑压缩非关键输出 |
| > 90% | **必须**请求用户干预 |

### 5.2 检查点机制

**保存时机**：
- 每个 Phase 结束时

**检查点内容**：
- 当前阶段
- 完成时间
- Token 使用
- 输出文件
- 下一阶段
- 状态说明

**恢复机制**：
- 如需从检查点恢复（用户轮换上下文）
- 读取最新检查点
- 恢复 VERSION_MANIFEST.json
- 从 next_phase 继续

### 5.3 资源利用原则

**参考文献资源**：
- `researcher`：学习相关领域的方法论和最佳实践
- `modeler`：参考类似问题的建模方法
- `summarizer`：学习高质量 MCM 论文的摘要写法
- `advisor`：对比论文质量与参考论文

**LaTeX 模板资源**：
- `writer` 必须复制 `latex_template/` 到 `output/paper/`
- 禁止自创 LaTeX 文档
- 最低 23 页要求

**网络搜索**：
- `researcher` 鼓励搜索相关学术论文和方法

---

## 六、数据完整性标准

### 6.1 标量原则

CSV/Excel 输出必须**仅包含标量值** (int, float, string, boolean)。

**绝对禁止**：
- 存储序列化对象（List, Dict, Numpy Object）

### 6.2 类型安全

生成数据的代码必须包含 `check_data_quality()` 函数，输出前断言数据类型。

### 6.3 自我修正

Data Engineer 必须在提交前运行自检，发现非标量列立即修复。

---

## 七、Sanity Check 思维

所有 Agent 在验证时应具备 Sanity Check 思维：

### 7.1 常识判断

- 预测结果是否符合常识？
- 主办国应该比平时表现更好
- 强国预测应该在历史范围附近

### 7.2 历史对比

- 与历史数据对比是否合理？
- 预测区间是否有效？

### 7.3 逻辑一致

- 不同文件之间的数据是否一致？
- 日志中的关键数字与保存的文件内容是否一致？

### 7.4 预测 Sanity Check（v2.4.2）

Phase 5 输出后必须执行的 7 项检查：
1. 无重复 NOC/国家名
2. 无已解散国家
3. 强国预测在合理范围
4. 主办国预测 > 非主办时期平均
5. Gold 预测 < Total 预测
6. Median 不应全为 0
7. 预测区间有效（PI_97.5 >= Mean >= PI_2.5）

---

## 八、输出一致性原则

鉴于 v2.4.1 实验中出现的数据不一致问题，v2.4.2 提醒所有 Agent：

### 8.1 唯一标识

国家、变量等应使用统一的标识格式（NOC 代码或全名，不可混用）。

### 8.2 避免覆盖

不同模型/任务的输出应使用不同的文件名：
- `predictions_2028_total.csv`
- `predictions_2028_gold.csv`

### 8.3 日志-文件一致

训练完成后，应检查日志中的关键数字与保存的文件内容一致。

---

## 九、设计哲学总结

**核心理念**：
1. **质量优先**：宁可多次返工，不可放过问题
2. **完整性**：禁止简化或跳过任何阶段
3. **独立验证**：验证者必须独立判断，亲自检查
4. **数据一致**：所有输出数据必须一致，可追溯
5. **反偷懒**：自动降级但不跳过
6. **自包含**：Agent 文件必须包含所有必要信息

**质量公式**：
```
最终质量 = Σ(每个阶段的质量) × 验证严格度
```

只有在每个 Validation Gate 都保持高标准，才能确保最终产出的质量。

---

**文档版本**: v2.5.1
**创建日期**: 2026-01-10
