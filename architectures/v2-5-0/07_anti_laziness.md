# MCM-Killer v2.5.0: 反偷懒机制

> **防止 AI 跳过阶段或降低输出质量的强制措施**
>
> **版本**: v2.5.0
> **最后更新**: 2026-01-07

---

## 一、问题背景

### 1.1 v2.4.1 的问题

在 v2.4.1 的执行中发现：
- **Phase 5 完全跳过**（0% 完成）
- 理由："context 已使用较大"、"模型训练需要 8-10 小时"
- AI 自主决定跳过，未请求用户干预
- 违反了"完整性强制令"

### 1.2 根本原因

1. **缺少强制执行机制**
   - "禁止跳过"只是软约束
   - AI 可以找到理由合理化跳过

2. **缺少轻量级选项**
   - 只有"完整训练"（4-6 小时）
   - 没有"快速验证"选项
   - 导致 AI 选择全部跳过

3. **缺少用户决策机制**
   - 遇到冲突时，AI 自行决定
   - 没有强制要求用户介入

---

## 二、反偷懒核心原则

### 2.1 完整性强制令 v2.5.0

```markdown
## MCM-Killer 完整性强制令 v2.5.0

1. **禁止跳过（No Skipping）**
   - 每个阶段必须执行
   - 如遇问题，必须调用用户决策
   - 禁止 AI 自主决定跳过任何阶段

2. **质量优先（Quality First）**
   - 当 Token 接近限制时，**必须**请求用户干预
   - 绝不允许为了省 Token 而降低输出质量
   - 绝不允许生成"摘要版"报告

3. **轻量级优先（Lightweight First）**
   - 对于耗时操作（如训练），必须提供快速选项
   - 完整版可作为"可选"或"后续优化"
   - 但快速版必须完成

4. **用户决策优先（User Decision First）**
   - 遇到任何"质量 vs 效率"的冲突
   - 必须请求用户决策
   - 禁止 AI 擅自决定
```

---

## 三、Phase 5 反偷懒设计

### 3.1 两阶段强制执行

```
Phase 5: 模型训练
│
├─→ Phase 5A: 快速验证（MANDATORY, ≤30 min）
│   │
│   │   ✅ 必须执行
│   │   ✅ 使用减少样本/迭代
│   │   ✅ 确保代码可运行
│   │   ✅ 验证模型基本可行
│   │
│   └─→ 输出：results_quick_1.csv
│
└─→ Phase 5B: 完整训练（OPTIONAL, 4-6 hours）
    │
    │   ⚠️ 可选执行
    │   ⚠️ 完整 HMC 采样
    │   ⚠️ 如时间不足，可标记为"后续优化"
    │
    └─→ 输出：results_1.csv
```

### 3.2 禁止行为

```
❌ 禁止：完全跳过 Phase 5
❌ 禁止：理由"时间不足"就跳过
❌ 禁止：理由"Token 不足"就跳过
✅ 必须：至少完成 Phase 5A
✅ 必须：5A 完成后才能考虑跳过 5B
```

### 3.3 快速验证策略（5A）

**目的**：确保代码可运行，模型基本可行

**具体策略**：
- 使用 10-20% 的数据
- 减少迭代次数（500 vs 2000）
- 快速收敛检查
- 预计时间：≤30 分钟

**验证标准**：
- 代码无错误运行
- 产生合理的输出
- 基本 sanity check 通过

### 3.4 完整训练策略（5B）

**条件**：
- 5A 成功完成
- 有足够的 Token
- 用户未选择跳过

**具体策略**：
- 完整数据集
- 完整 HMC 采样（2000+ 迭代）
- 完整收敛诊断
- 预计时间：4-6 小时

---

## 四、Token 管理机制

### 4.1 Token 监控

**Director 职责**：
- 每个阶段结束后检查 Token 使用
- 记录到检查点文件
- 在超过阈值时发出警告

### 4.2 阈值和行动

| Token 使用率 | 行动 |
|-------------|------|
| < 80% | 正常执行 |
| 80% - 90% | 发出警告，考虑压缩输出 |
| > 90% | **必须**请求用户干预 |

### 4.3 绝对禁止

```
❌ 禁止：擅自跳过阶段以节省 Token
❌ 禁止：生成"摘要版"报告以节省 Token
❌ 禁止：降低输出质量以节省 Token
✅ 必须：请求用户决策（轮换上下文或继续）
```

### 4.4 用户决策请求格式

```markdown
## Token 不足警告

**当前状态**：
- 已使用 Token：{current} / {limit} ({percentage}%)
- 当前阶段：Phase {i}
- 剩余阶段：{list}

**选项 A：请求用户轮换上下文**
- 优点：可以继续高质量输出
- 缺点：需要用户操作

**选项 B：压缩输出继续**
- 优点：无需用户操作
- 缺点：可能降低质量

**选项 C：跳过非关键阶段**
- 优点：节省 Token
- 缺点：可能影响完整性

**推荐**：{Director 的推荐}

请用户选择 A、B 或 C，或提供其他指示。
```

---

## 五、检查点机制

### 5.1 检查点保存

**每个 Phase 结束时**：
1. 保存当前状态到 `output/.checkpoint_phase{i}.json`
2. 记录已完成的文件
3. 记录 manifest 状态
4. 记录 Token 使用情况

### 5.2 检查点格式

```json
{
  "phase": 5,
  "phase_name": "Model Training",
  "completed_at": "2026-01-07 12:30:00",
  "token_usage": 95000,
  "token_limit": 200000,
  "token_percentage": 47.5,
  "outputs": [
    "output/implementation/data/results_quick_1.csv",
    "output/implementation/logs/training_quick_1.log"
  ],
  "manifest_snapshot": {
    "files": {...},
    "agent_calls": {...}
  },
  "next_phase": 6,
  "status": "5A completed, 5B skipped (user decision)"
}
```

### 5.3 恢复机制

如果需要从检查点恢复：
1. 读取检查点文件
2. 恢复 VERSION_MANIFEST.json
3. 从下一个 Phase 继续

---

## 六、质量标准

### 6.1 最低质量要求

**每个阶段的输出必须满足**：

| Phase | 最低要求 |
|-------|---------|
| 0 | 完整的 PDF 转换和需求提取 |
| 1 | 完整的数学模型设计，不能是"简要描述" |
| 2 | 可行性分析，必须明确说明能否实现 |
| 3 | 数据必须通过质量检查，不能有"待处理" |
| 4 | 代码必须可运行，不能是"伪代码" |
| 5 | **至少**完成 5A 快速验证 |
| 6 | 必须生成所有需要的图表 |
| 7 | 完整的论文，不能是"大纲" |
| 8 | 完整的摘要，恰好 1 页 |
| 9 | 润色后的版本，不能是"简要修改" |
| 10 | 完整的质量报告 |

### 6.2 禁止的输出

```
❌ "由于 Token 限制，仅提供摘要"
❌ "详细内容请参考后续版本"
❌ "代码框架，待完善"
❌ "结果待验证"
✅ 必须提供完整、可用的输出
```

---

## 七、Director 强制检查清单

**每个 Phase 结束时，Director 必须确认**：

```markdown
## Phase {i} 完成性检查

- [ ] 是否生成了该 Phase 定义的所有文件？
- [ ] 是否执行了完整的 Validation Gate（包括所有验证者）？
- [ ] 是否有任何步骤被"简化"或"跳过"？
- [ ] 输出质量是否满足最低标准？
- [ ] Token 使用情况是否需要警告？
- [ ] 是否需要保存检查点？

**如果有任何"否"，必须采取行动。**
```

---

## 八、常见违规场景和对策

### 8.1 场景 1：Token 不足

**违规**：
```
❌ "Token 不足，跳过 Phase 5"
```

**正确**：
```
✅ 完成至少 Phase 5A（快速验证，≤30 min）
✅ 如果仍不足，请求用户决策
```

### 8.2 场景 2：训练时间长

**违规**：
```
❌ "训练需要 8-10 小时，跳过"
```

**正确**：
```
✅ 完成至少 Phase 5A（快速验证）
✅ Phase 5B 可标记为"后续优化"
✅ 在验证报告中明确说明
```

### 8.3 场景 3：数据不完整

**违规**：
```
❌ "部分数据缺失，简化处理"
```

**正确**：
```
✅ 使用现有数据，但不降低质量
✅ 在报告中明确说明数据限制
✅ 咨询 @modeler 是否需要调整模型
```

### 8.4 场景 4：多次返工

**违规**：
```
❌ "返工 3 次，通过即可"
```

**正确**：
```
✅ 第 4 次返工仍需同样标准
✅ 考虑回退到更早阶段
✅ 请求用户决策
```

---

## 九、实施指南

### 9.1 Director 的职责

1. **严格执行**：
   - 每个阶段必须完成
   - 每个验证 Gate 必须执行
   - 不能因为"时间紧"就放松标准

2. **Token 监控**：
   - 每个阶段后检查 Token
   - 超过阈值时请求用户决策
   - 保存检查点

3. **质量把关**：
   - 检查输出是否满足最低标准
   - 拒绝"摘要版"、"框架版"输出
   - 要求完整、可用的产出

### 9.2 Agent 的职责

1. **完整执行**：
   - 按要求完成所有步骤
   - 不能自行简化
   - 遇到问题上报 Director

2. **质量保证**：
   - 输出必须完整可用
   - 不能是"待完善"的状态
   - 必须通过自检

3. **诚实沟通**：
   - Token 不足时明确说明
   - 时间不够时请求决策
   - 不能自行决定跳过

---

## 十、总结

**反偷懒机制的核心**：
1. **强制执行**：每个阶段必须完成
2. **轻量级选项**：提供快速验证路径
3. **用户决策**：遇到冲突必须请求用户
4. **Token 监控**：定期检查，提前预警
5. **检查点**：支持恢复和断点续传
6. **质量标准**：明确最低要求

**目标**：
- 确保所有阶段至少有基本产出
- 防止 AI 自主决定跳过
- 在有限 Token 下最大化质量
- 提供清晰的用户决策点

---

**版本**: v2.5.0
**最后更新**: 2026-01-07
