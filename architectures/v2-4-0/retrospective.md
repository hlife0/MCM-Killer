# v2.4.0 系统性反思：从 v2.0 到 v2.3 的问题根源分析

> **内部文档** — 不是给 Agent 看的，是给我们自己理解问题用的。

---

## 文档关系

| 文档 | 职责 |
|------|------|
| **`retrospective.md`（本文档）** | 分析 v2.0-v2.3 的问题根源 |
| `methodology.md` | 定义设计原则和方法论 |
| `architecture.md` | 定义具体架构和 Agent 契约 |

阅读顺序：retrospective → methodology → architecture

---

## 引言

这份文档不是"问题列表"，而是对整个系统演进过程的**根因分析**。

我们的目标不是"修复"某个具体问题，而是理解"为什么这类问题会反复出现"，从而在 v2.4 中**从根本上消除**产生这类问题的土壤。

---

## 一、版本演进历史

| 版本 | 核心变化 | 试图解决的问题 | 引入的新问题 |
|------|---------|---------------|-------------|
| v2.0 | 创建 13 个 Agent | 无（初始版本） | Prompt 冗长混乱 |
| v2.1 | 添加问题类型感知 | 所有问题都用预测模型处理 | Prompt 更长，规则分散 |
| v2.2 | 删除代码示例 | Prompt 太长 | Agent 失去"肌肉记忆"，开始幻觉 |
| v2.3 | 恢复代码示例 | v2.2 的幻觉问题 | 恢复不完整，冲突加剧 |

**观察**：每一次版本升级都是在"修复上一版本的症状"，而不是"解决根本问题"。

---

## 二、问题的三个层次

### 第一层：表面症状

这些是我们在 v2.3 中观察到的具体问题：

- Advisor 说 10 成员，CLAUDE.md 说 13 成员
- Editor 输出路径在不同文件中定义不同
- Validator 不知道何时被调用
- 某些 Agent 只有骨架，缺乏实现细节

### 第二层：结构缺陷

这些是导致表面症状的结构性问题：

1. **信息重复**：同一规则在多处定义（CLAUDE.md、Agent prompts）
2. **缺乏契约**：Agent 间的接口没有明确定义
3. **演进无序**：修改时没有统一的流程，导致不同文件更新不同步
4. **验证缺失**：没有机制检查系统是否一致

### 第三层：根本原因

**缺乏一个"规范层"来作为所有规则的唯一真相源。**

当前系统的架构是这样的：

```
┌─────────────────────┐
│    CLAUDE.md        │  ← 定义了一些规则
├─────────────────────┤
│  Agent Prompt 1     │  ← 也定义了一些规则
│  Agent Prompt 2     │  ← 也定义了一些规则
│  ...                │
│  Agent Prompt 13    │  ← 也定义了一些规则
└─────────────────────┘
```

问题在于：**没有人知道哪个文件里的规则是"权威"的**。

---

## 三、深度反思：为什么会走到这一步？

### 3.1 设计债务的累积

v2.0 创建时，可能的思路是：

> "先让系统能跑起来，之后再优化。"

这导致了"先写代码再补文档"的模式。每个 Agent prompt 都是独立写的，没有先设计整体架构。

### 3.2 修复变成了补丁

当问题出现时，修复的方式是：

> "哪里报错改哪里。"

而不是：

> "这个问题反映了什么系统性缺陷？"

### 3.3 缺乏"元层"思维

系统中有 13 个 Agent，但没有一个**元层**来管理这些 Agent 的定义。

这就像：
- 有 13 个微服务，但没有 API Gateway
- 有 13 个数据库表，但没有 Schema 定义

---

## 四、具体问题的根因映射

| 表面问题 | 结构缺陷 | 根本原因 |
|---------|---------|---------|
| 成员数量不一致 | 信息重复 | 团队规模应该只在一处定义 |
| 路径不一致 | 缺乏契约 | 目录结构应该有统一契约 |
| `_final` 冲突 | 信息重复 | 命名规范应该只在一处定义 |
| Validator 触发不明 | 缺乏契约 | Agent 间协议应该有显式定义 |
| 骨架 Agent | 演进无序 | 恢复时没有完整性检查 |
| 验证报告路径不统一 | 信息重复 | 输出路径应该由契约定义 |

**共同的根本原因**：没有规范层。

---

## 五、v2.3 遗留问题完整清单

### 5.1 契约类问题

| ID | 问题 | 影响 |
|----|------|------|
| C1 | Agent 输入输出没有统一定义 | 不知道谁产生什么、谁消费什么 |
| C2 | 触发条件分散在各处 | Director 难以编排 |
| C3 | 验证门没有统一规范 | Validator 不知道检查什么 |

### 5.2 一致性问题

| ID | 问题 | 受影响的文件 |
|----|------|-------------|
| I1 | 团队成员数量 | CLAUDE.md, advisor.md, reader.md |
| I2 | Agent 名称 | 多处使用 Coder/Code_Translator |
| I3 | 输出路径 | editor.md 引用了不存在的 `processed/` |
| I4 | Editor 输出命名 | CLAUDE.md 说 `_final`, prompt 禁止 |

### 5.3 完整性问题

| ID | 问题 | 严重程度 |
|----|------|---------|
| M1 | validator.md 只有 87 行（应 680 行） | 严重 |
| M2 | writer.md 只有 101 行（应 800 行） | 严重 |
| M3 | Researcher 没有 Docling 但可能需要读 PDF | 中等 |

### 5.4 架构类问题

| ID | 问题 | 影响 |
|----|------|------|
| A1 | 没有单一真相源 | 规则冲突 |
| A2 | 没有验证机制 | 无法检测不一致 |
| A3 | 没有演进流程 | 每次修改都可能引入新问题 |

---

## 六、v2.4 需要解决的核心命题

基于以上分析，v2.4 必须回答以下问题：

1. **规范层**：什么是所有规则的唯一真相源？格式是什么？
2. **契约系统**：如何定义 Agent 的输入/输出/触发条件？
3. **一致性**：如何确保所有文件不冲突？
4. **演进流程**：修改规则时应该遵循什么流程？
5. **验证机制**：如何自动检测问题？

---

## 七、不应该做的事

在设计 v2.4 时，我们应该避免：

1. ❌ 直接修复 v2.3 的具体问题（这是打补丁）
2. ❌ 在 Agent prompt 中添加更多规则（这会加剧分散）
3. ❌ 让 CLAUDE.md 更长（这不解决根本问题）

我们应该：

1. ✅ 先设计规范层 → 见 `methodology.md`
2. ✅ 从规范生成/约束所有其他文件 → 见 `architecture.md`
3. 📋 建立验证机制 → 待完成

---

## 结语

v2.0 到 v2.3 的演进过程，本质上是一个**技术债务累积**的过程。

每次修复都是在还利息，而不是还本金。

v2.4 的目标是**还清本金**：建立一个正确的架构基础，让未来的修改不再产生新的债务。

---

**文档版本**: 1.0
**日期**: 2026-01-03
