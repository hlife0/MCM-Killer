# v2.4.1 方法论 (Methodology)

> **状态**: 草案
> **基于**: v2.4.0 经验 (数据失败 & 简化尝试)

## 1. 防御性 Agent 工程 (Defensive Agent Engineering)

v2.4.0 实验表明，Agent（特别是生成代码的 Data Engineer 和 Modeler）容易出现"静默失败"。

### 1.1 "提交前验证"原则 (Verify-Before-Submit)
每个生成代码的 Agent 必须在其工作流中包含 **自我验证步骤**：
1.  **生成代码**: 编写处理逻辑。
2.  **生成测试**: 编写断言以检查数据类型（例如：CSV 中无对象）和逻辑。
3.  **执行与修复**: 运行代码。如果断言失败，必须在提交前修复代码。

### 1.2 显式 Schema 契约
-   **输出约束**: 所有 CSV/Excel 输出必须仅包含标量值 (int, float, str, bool)。
-   **验证**: 生产者 Agent 必须运行 `df.dtypes` 检查。

## 2. 验证效率

### 2.1 自动化预验证 (Automated Pre-Validation)
-   **脚本优先**: 在人工/LLM 审查之前，运行自动化脚本检查文件是否存在及基本格式。
-   **快速失败**: 如果脚本失败，立即拒绝，不消耗 LLM Token。

## 3. "完整性铁律" (The Completeness Mandate)

### 3.1 禁止简化政策
-   **绝对规则**: 系统必须严格执行 10 个阶段的所有步骤。
-   **禁止行为**:
    -   "总结"一个阶段而非执行它。
    -   跳过验证门（即使"代码暗示它能工作"）。
    -   生成"草稿"输出代替"最终"输出以节省时间。

### 3.2 Token 限制协议
-   如果 Token 使用达到临界值：**暂停 (PAUSE)**。
-   **禁止**: 为了适应上下文窗口而降低质量。
-   **行动**: 通知用户（"Token limit reached, please rotate context or authorize continuation"）并等待。

## 4. 返工协议优化
-   **有条件通过**: 允许非阻塞性问题通过。
-   **阻塞性失败**: 对数据完整性违规（如 CSV 中的列表对象）必须进行阻塞性拒绝。
