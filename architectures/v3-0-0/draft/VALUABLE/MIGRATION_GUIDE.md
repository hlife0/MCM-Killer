# VALUABLE 迁移指南

> **文档路径**: `D:/migration/MCM-Killer/architectures/v3-0-0/draft/VALUABLE/MIGRATION_GUIDE.md`
> **创建时间**: 2026-01-24
> **目的**: 为 MCM-Killer 或其他系统提供 LLM-MM-Agent 核心资产的迁移指南

---

## 迁移优先级矩阵

| 星级 | 优先级 | 数量 | 迁移策略 | 预计工作量 |
|------|--------|------|----------|------------|
| ⭐⭐⭐⭐⭐⭐ | P0 | 29 | 必须迁移，不可替代 | 4-6 周 |
| ⭐⭐⭐⭐⭐ | P1 | 16 | 强烈推荐，高度复用 | 2-3 周 |
| ⭐⭐⭐⭐ | P2 | 16 | 可选迁移，值得参考 | 1-2 周 |

---

## 第一阶段: P0 核心资产 (4-6 周)

### 1. 提示词系统 (1 周)

**来源**: `03_MMAgent_Prompt.md`, `template.py`

**迁移任务**:
- [ ] 迁移 `BASE_SYSTEM_PROMPT` - 多 Agent 系统基础
- [ ] 迁移 `CODING_SYSTEM_PROMPT` - 代码生成规范
- [ ] 实现 `SafePlaceholder` 模式 - 防止模板格式化崩溃
- [ ] 迁移 45+ 提示词模板 - 阶段专用提示词

**验证标准**:
- Agent 不重复其他 Agent 的工作
- 生成的代码包含强制 6 行导入
- 模板格式化不会崩溃

### 2. DAG 调度器 (1 周)

**来源**: `coordinator.py`

**迁移任务**:
- [ ] 实现拓扑排序算法
- [ ] 实现类型归一化
- [ ] 实现循环检测
- [ ] 实现 Memory 管理

**验证标准**:
- 正确处理复杂任务依赖
- 检测并报告循环依赖
- 类型归一化防止 KeyError

### 3. HMML 知识库 (1.5 周)

**来源**: `14_HMML.md`, `HMML.md`, `HMML.json`

**迁移任务**:
- [ ] 创建 3 层层级结构
- [ ] 实现 98+ 方法节点
- [ ] 实现嵌入相似度检索
- [ ] 实现 HMML JSON 格式

**验证标准**:
- 检索结果与查询语义相关
- 支持 3 层层级遍历
- JSON 格式可程序化访问

### 4. Context Pruning 策略 (0.5 周)

**来源**: `mathematical_modeling.py`

**迁移任务**:
- [ ] 实现远近亲疏策略
- [ ] 实现上下文裁剪
- [ ] 实现直接前驱完整上下文
- [ ] 实现其他依赖最小上下文

**验证标准**:
- 上下文不超过 Token 限制
- 直接前驱获得完整信息
- Token 成本显著降低

### 5. Schema Registry (0.5 周)

**来源**: `data_manager.py`, `schema_registry.py`

**迁移任务**:
- [ ] 实现单一数据源模式
- [ ] 实现数据快照机制
- [ ] 实现 Schema 注册表
- [ ] 实现列名验证

**验证标准**:
- LLM 不产生幻觉列名
- 所有数据访问通过单一数据源
- 列名验证防止 KeyError

### 6. 自愈机制 (1 周)

**来源**: `autofixer.py`, `syntax_fixer.py`

**迁移任务**:
- [ ] 实现 3 层自愈模式
- [ ] 实现快速修复 (规则匹配)
- [ ] 实现中度修复 (LLM 辅助)
- [ ] 实现深度修复 (完整诊断)

**验证标准**:
- 常见错误在 1 秒内修复
- 复杂错误在 10 秒内修复
- 自愈成功率 > 80%

### 7. Checkpoint 机制 (0.5 周)

**来源**: `main.py`

**迁移任务**:
- [ ] 实现自动保存检查点
- [ ] 实现透明恢复
- [ ] 实现增量保存

**验证标准**:
- 每个 Stage 后自动保存
- 系统崩溃后自动从断点恢复
- 用户无需手动操作

### 8. Omni-Survival Kit (0.5 周)

**来源**: `main.py`

**迁移任务**:
- [ ] 实现死手开关
- [ ] 实现紧急 PDF 生成
- [ ] 实现 atexit 注册

**验证标准**:
- 即使崩溃也生成 PDF
- 使用可用输出生成 PDF
- 用户总能获得输出

### 9. Truth Mode 日志 (0.5 周)

**来源**: `execution_tracker.py`

**迁移任务**:
- [ ] 实现完整事件追踪
- [ ] 实现时间戳记录
- [ ] 实现可读日志生成

**验证标准**:
- 记录所有事件
- 时间戳精确到毫秒
- 日志便于人类阅读

---

## 第二阶段: P1 关键资产 (2-3 周)

### 1. Actor-Critic 迭代 (0.5 周)

**来源**: `problem_analysis.py`

**迁移任务**:
- [ ] 实现 Actor 生成
- [ ] 实现 Critic 评估
- [ ] 实现迭代改进
- [ ] 实现收敛检测

### 2. 法医式尸检 (0.5 周)

**来源**: `latent_reporter.py`

**迁移任务**:
- [ ] 实现后处理分析
- [ ] 实现失败原因分析
- [ ] 实现修复建议生成
- [ ] 实现自愈统计

### 3. 变量契约系统 (0.5 周)

**来源**: `variable_contract.py`

**迁移任务**:
- [ ] 实现变量依赖管理
- [ ] 实现契约验证
- [ ] 实现契约提示词

### 4. 语法修复器 (0.5 周)

**来源**: `syntax_fixer.py`

**迁移任务**:
- [ ] 实现常见语法错误修复
- [ ] 实现缺失导入修复
- [ ] 实现路径错误修复

### 5. 鲁棒 JSON 解析 (0.5 周)

**来源**: `json_utils.py`

**迁移任务**:
- [ ] 实现多级防御策略
- [ ] 实现输出清理
- [ ] 实现常见错误修复

### 6. 数据管理架构 (0.5 周)

**来源**: `data_manager.py`

**迁移任务**:
- [ ] 实现单一数据源
- [ ] 实现数据快照
- [ ] 实现列名规范化

---

## 第三阶段: P2 重要组件 (1-2 周)

### 1. 统一 LLM 接口 (0.5 周)

**来源**: `llm.py`

**迁移任务**:
- [ ] 实现多模型支持
- [ ] 实现线程锁防 Error 429
- [ ] 实现 Token 跟踪

### 2. 速率限制器 (0.5 周)

**来源**: `rate_limiter.py`

**迁移任务**:
- [ ] 实现 Singleton 模式
- [ ] 实现 Semaphore 并发控制
- [ ] 实现滑动窗口

### 3. 叙述生成模块 (1 周)

**来源**: `narrative_weaver.py`, `academic_tools.py`

**迁移任务**:
- [ ] 实现叙述编织器
- [ ] 实现学术写作工具
- [ ] 实现批评生成器

### 4. 报告生成框架 (1 周)

**来源**: `reporting/`, `solution_reporting.py`

**迁移任务**:
- [ ] 实现多格式报告生成
- [ ] 实现 Markdown 报告
- [ ] 实现 LaTeX 报告
- [ ] 实现 PDF 生成

---

## 扩展到 400+ 方法和 8+ 阶段

### HMML 扩容 (3-4 周)

**当前**: 98+ 方法，3 层层级
**目标**: 400+ 方法，5 层层级

**任务**:
1. 重新设计层级结构 (1 周)
   - 添加 Method Categories (4 级)
   - 添加 Method Variants (5 级)
   - 定义层级关系

2. 建立动态方法注册机制 (1 周)
   - 实现 HMMLRegistry
   - 实现方法注册 API
   - 实现自动分类

3. 优化嵌入相似度检索 (1 周)
   - 集成 FAISS 索引
   - 实现分层检索
   - 实现缓存机制

4. 建立方法分类和索引系统 (1 周)
   - 实现自动分类
   - 实现方法索引
   - 实现快速查找

### 工作流扩展 (2-3 周)

**当前**: 4 阶段管道
**目标**: 8+ 阶段管道

**任务**:
1. 设计新阶段 (1 周)
   - Phase 0.5: 模型质量门控
   - Phase 1.5: 设计验证
   - Phase 2.5: 可行性检查
   - Phase 3.5: 代码验证
   - ...

2. 创建新阶段提示词 (1 周)
   - 为每个新阶段创建专用提示词
   - 定义阶段输入输出
   - 定义验证标准

3. 扩展 DAG 调度器 (0.5 周)
   - 支持更多阶段
   - 优化拓扑排序
   - 实现并行调度

4. 扩展 Context Pruning (0.5 周)
   - 实现上下文重要性评分
   - 实现动态裁剪
   - 实现向量压缩

---

## 验收标准

### 功能验收

- [ ] 所有 P0 资产成功迁移
- [ ] 所有 P1 资产成功迁移
- [ ] 核心功能正常工作

### 性能验收

- [ ] 系统响应时间 < 10 秒/任务
- [ ] Token 成本降低 > 80%
- [ ] 代码执行成功率 > 90%

### 质量验收

- [ ] 所有测试通过
- [ ] 无重大 Bug
- [ ] 文档完整

---

## 风险和缓解

### 风险 1: 工作量估计不准确

**缓解**: 分阶段执行，每阶段评估并调整计划

### 风险 2: 技术难点卡住

**缓解**: 提前识别技术难点，准备备选方案

### 风险 3: 兼容性问题

**缓解**: 充分测试，逐步迁移，保持向后兼容

### 风险 4: 资源不足

**缓解**: 优先迁移 P0 资产，P1/P2 可根据实际情况调整

---

## 总结

**总工作量**: 7-11 周
- P0 核心资产: 4-6 周
- P1 关键资产: 2-3 周
- P2 重要组件: 1-2 周

**关键成功因素**:
1. 严格按照优先级执行
2. 充分测试每个迁移的资产
3. 保持文档更新
4. 及时识别和处理风险

**预期收益**:
1. Token 成本降低 ~87%
2. 代码执行成功率提升 ~30%
3. 系统鲁棒性显著提升
4. 可扩展到 400+ 方法和 8+ 阶段

---

**文档版本**: v1.0
**最后更新**: 2026-01-24
