# LLM-MM-Agent: 工具集

> Path: `clean version/LLM-MM-Agent/MMAgent/utils/`
> **重要程度**: ⭐⭐⭐ 辅助功能支撑层

本目录包含 40+ 工具模块，为系统提供安全验证、数据处理、代码执行、图表生成、日志管理、质量评估等辅助功能。这些工具模块被各个 Agent 和核心组件调用，构成了系统的基础设施。

---

## 安全验证模块

### `ast_path_guard.py` ⭐⭐⭐
**AST 路径保护模块**，验证和保护抽象语法树中的文件路径。防止恶意代码通过路径遍历攻击访问敏感文件（如 /etc/passwd、环境变量、密钥文件）。采用白名单机制，只允许访问指定目录。是代码执行安全的第一道防线。

### `ast_validator.py` ⭐⭐⭐
**抽象语法树验证器**，检查生成代码的 AST 合法性。识别安全风险（危险函数调用、可疑导入）、语法错误（括号不匹配、缩进错误）、逻辑问题（无限循环、未定义变量）。在代码执行前进行静态分析，拦截潜在恶意代码。

### `canonical_whitelist.py` ⭐⭐⭐
**代码安全白名单**，定义允许的 Python 操作和模块的官方列表。任何不在白名单中的操作都会被拒绝执行。白名单包括数据处理（numpy, pandas）、可视化（matplotlib）、数学计算（scipy）、基础工具等安全模块。明确禁止网络操作、文件写入、系统调用等危险操作。是代码执行的硬性安全边界。

### `code_guards.py` ⭐⭐⭐
**代码安全守卫**，防止恶意代码的动态执行检查。扫描代码中的危险操作模式（文件操作、网络请求、系统调用、子进程执行）、在代码执行前进行安全验证、拦截或警告潜在危险操作。与静态 AST 验证配合，提供多层安全保障。

### `code_guards_enhanced.py` ⭐⭐
**增强版代码安全系统**，提供更全面的动态安全检查。包括运行时行为监控（检测异常内存使用、长时间运行）、动态分析（追踪实际执行的操作）、异常检测（识别意外行为）。是对基础 code_guards 的增强版本。

### `env_guard.py` ⭐⭐
**环境安全守卫**，保护执行环境的隔离性和资源限制。限制 CPU 使用时间（防止无限循环）、限制内存分配（防止内存泄漏）、隔离执行环境（沙箱机制）、监控异常行为。确保系统资源不被恶意代码耗尽。

### `import_guard.py` ⭐⭐⭐
**导入安全守卫**，限制不安全的模块导入。只允许白名单中的模块被导入（如 numpy, pandas, matplotlib）；明确禁止危险模块（如 os, subprocess, socket, requests）；检测动态导入尝试（__import__）。防止恶意代码通过导入危险模块进行攻击。

---

## 数据处理模块

### `column_normalization.py` ⭐⭐
**数据列标准化**，统一数据集的列名和格式。处理命名不一致（空格、大小写、特殊字符）、类型不匹配（数值存储为字符串）、缺失值标记（NaN, None, "NA"）。确保数据在后续处理中的一致性。

### `data_manager.py` ⭐⭐
**数据管理系统**，管理数据的加载、缓存、版本控制。提供统一的数据访问接口、自动缓存机制避免重复加载、数据版本追踪、数据源切换。简化数据操作，提升效率。

### `data_models.py` ⭐⭐
**数据模型定义**，定义系统中使用的各种数据结构。包括任务模型（Task）、结果模型（Result）、配置模型（Config）等。使用 Pydantic 或 dataclass 确保类型安全和数据验证。

### `data_normalization.py` ⭐⭐
**数据标准化工具**，将数据转换为标准格式。处理单位统一（如 km 转 m）、编码转换（UTF-8, ASCII）、格式对齐（日期格式、数字格式）。确保数据可被正确处理。

### `data_preprocessing.py` ⭐⭐⭐
**数据预处理管道**，进行数据清洗、转换、特征工程。包括缺失值处理（删除、填充、插值）、异常值检测（统计方法、箱线图）、特征编码（独热编码、标签编码）、特征缩放（标准化、归一化）。是机器学习建模的关键前置步骤。

### `convert_format.py` ⭐⭐
**格式转换工具**，在不同数据格式之间转换。支持 JSON、CSV、Excel、Markdown、YAML 等格式的互转。处理编码问题、格式差异、类型映射。

---

## 计算与执行模块

### `computational_solving.py` ⭐⭐⭐
**计算求解管道**，生成和执行求解代码。将数学模型转换为可执行 Python 代码、在安全隔离环境中执行、捕获输出和错误、提取结果数值。包含代码生成、执行、结果提取的完整流程。是建模阶段的核心执行组件。

### `execution_fsm.py` ⭐⭐
**执行有限状态机**，用状态机管理执行流程。定义状态（初始化、运行、暂停、完成、失败）、转换规则（何时切换状态）、状态动作（每个状态执行的操作）。确保执行流程的正确性和可预测性。

### `execution_tracker.py` ⭐⭐⭐
**综合事件跟踪系统（Truth Mode）**，记录所有执行事件的详细日志。包括 LLM 调用（请求、响应、Token 使用）、代码执行（输入、输出、错误）、状态变化、错误发生、性能指标。提供完整的事件追踪和事后分析能力，是调试和优化的关键数据源。

### `failure_handler.py` ⭐⭐
**故障处理和恢复模块**，处理各种故障情况。提供重试机制（指数退避、最大次数）、降级策略（简化任务、跳过非关键步骤）、恢复方案（从检查点恢复）。增强系统的鲁棒性和容错能力。

---

## 质量保证模块

### `auto_evaluation.py` ⭐⭐
**自动质量评估系统**，评估生成结果的质量。包括相关性评估（是否回答了问题）、准确性评估（计算是否正确）、完整性评估（是否遗漏要点）。自动打分并提供改进建议。

### `autofixer.py` ⭐⭐
**自动 bug 修复工具**，自动检测和修复代码中的常见错误。基于模式匹配和规则引擎，识别常见错误类型（语法错误、导入错误、缩进错误）、提供修复建议或自动修复。加速开发迭代。

### `fix_pattern_library.py` ⭐⭐
**Bug 修复模式库**，收集常见错误的修复模式。提供预定义的修复规则和模板（如缺失导入修复、缩进修复、变量名修复）。支持快速匹配和修复常见错误，加速 bug 修复过程。

### `syntax_fixer.py` ⭐⭐
**语法修正工具**，自动修正代码中的语法错误。基于语法分析和模式匹配，识别并修正括号不匹配、缩进错误、运算符错误等常见语法问题。提升代码生成质量。

---

## 图表可视化模块

### `chart_config.py` ⭐⭐
**图表配置管理**，管理图表的样式、尺寸、颜色等配置。提供配置模板（预设的样式方案）、默认值处理、配置继承机制。确保生成图表的一致性和美观性。

### `chart_templates.py` ⭐⭐
**图表模板库**，提供各种常见图表类型的代码模板。包括折线图（趋势分析）、柱状图（对比分析）、散点图（关系分析）、热力图（相关性）、3D 图（多维可视化）。每个模板都是可复用的完整代码片段。

### `minimal_chart_renderer.py` ⭐⭐
**最小化图表渲染器**，提供轻量级的图表生成功能。用于快速生成简单的可视化图表，无需复杂配置。适合原型开发和快速迭代。

---

## 日志与监控模块

### `latent_reporter.py` ⭐⭐
**后处理研究日志生成器**，在管道完成后生成研究日志。整理执行过程（关键事件、决策点）、分析结果（成功因素、失败原因）、生成人类可读的研究报告。帮助理解系统行为和积累经验。

### `logging_config.py` ⭐⭐
**结构化日志配置**，配置系统的日志输出。定义日志级别（DEBUG, INFO, WARNING, ERROR）、格式（时间戳、级别、模块、消息）、输出目标（文件、控制台）。支持多级别日志和彩色输出，便于调试。

### `rate_limiter.py` ⭐⭐⭐
**API 速率限制器**，防止 API 调用超限。实现令牌桶算法，控制请求速率（每秒请求数），避免触发 API 限流（429 错误）。与 llm.py 的线程锁配合，确保多线程环境下的 API 调用安全。

---

## 建模与分析模块

### `mathematical_modeling.py` ⭐⭐⭐
**数学建模管道**，进行方法选择、模型构建、求解。从 HMML 选择合适方法（基于相似度匹配）、构建数学模型（定义变量、约束、目标函数）、求解模型并验证结果（检查合理性、敏感性分析）。是数学建模的核心流程。

### `problem_analysis.py` ⭐⭐
**问题分析工具**，提供问题分析的辅助函数。包括问题类型识别（优化、预测、分类）、约束提取（等式约束、不等式约束）、目标解析（最大化、最小化）。为 problem_analysis Agent 提供底层支持。

### `sensitivity_analyzer.py` ⭐⭐
**敏感度分析引擎**，分析参数变化对结果的影响。识别关键参数、量化敏感性（参数变化率 → 结果变化率）、生成敏感度报告（排序、可视化）。对于模型验证和参数调优非常重要。

### `medal_allocation.py` ⭐⭐
**性能评估系统**，评估解决方案的质量。基于多个维度（创新性、准确性、完整性、可行性）打分，提供改进建议。模拟竞赛评审过程。

---

## 实用工具模块

### `embedding.py` ⭐⭐⭐
**嵌入生成模块**，为文本生成向量嵌入。用于相似度匹配、语义检索、聚类分析。支持多种嵌入模型（OpenAI embeddings, Sentence-BERT, GLM embeddings）。是 HMML 方法检索的核心技术。

### `incremental_builder.py` ⭐⭐
**增量构建系统**，支持增量式地构建和更新结果。避免重复计算（只重新计算变化的部分）、提高效率（利用缓存）、支持中断恢复（从断点继续）。适合长时间的迭代任务。

### `json_utils.py` ⭐⭐
**JSON 工具函数**，提供 JSON 的读写、验证、转换功能。处理复杂 JSON 结构（嵌套、数组）、编码问题（Unicode）、格式化（美化输出）。简化 JSON 操作。

### `path_autofix.py` ⭐⭐
**路径自动修正**，自动修正错误的文件路径。处理相对路径与绝对路径转换、跨平台路径（Windows 正斜杠、Linux 反斜杠）、路径拼接。提升代码的可移植性。

### `safe_merge.py` ⭐⭐
**安全数据合并**，安全地合并多个数据源。处理冲突（相同键的不同值）、不一致（类型不匹配）、类型不匹配（自动转换）。避免数据合并时的错误和丢失。

### `schema_manager.py` ⭐⭐
**模式管理系统**，管理数据模式定义和验证。提供模式注册、验证、转换功能。确保数据符合预定义的结构和类型。

### `schema_normalization.py` ⭐⭐
**模式标准化**，将不同的数据模式转换为统一格式。处理字段映射（名称不一致）、类型转换（字符串→数值）、结构对齐（嵌套层级）。

### `schema_registry.py` ⭐⭐
**模式注册表**，注册和管理系统中使用的所有数据模式。提供模式查询、验证、版本管理。是数据模式的中央仓库。

### `solution_reporting.py` ⭐⭐⭐
**解决方案报告模块（Omni-Survival Kit）**，确保即使系统崩溃也能生成 PDF 报告。实现死手开关机制（最后一道防线），提供多级降级策略（从完整报告到简化报告）。是系统可靠性的关键保障，确保用户总能获得输出。

### `utils.py` ⭐⭐
**通用工具函数**，提供各种常用功能。包括字符串处理、文件操作、时间处理、数学计算等。是系统的瑞士军刀。

### `variable_contract.py` ⭐⭐
**变量契约系统**，确保变量在系统中的命名和类型一致。定义变量契约（名称、类型、范围）、验证契约、强制执行契约。避免变量命名冲突和类型错误。

---

## 测试套件

### `tests/` ⭐⭐⭐
**测试套件目录**，包含 35+ 自动化测试文件。覆盖各个模块的功能测试、边界测试、错误处理测试。详见"测试基础设施"文档（07_Test_Infrastructure.md）。是保证系统正确性和稳定性的关键。

---

**文档版本**: v1.0
